<!DOCTYPE html>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Chromatic Aberration</title>

<div>
	<label for="file">File</label><br />
	<input id="file" type="file" accept="image/*" />
</div>

<br />

<div>
	<label for="amount">Amount</label><br />
	<input id="amount" type="number" value="5" />
</div>

<br />
<hr />
<br />

<div id="output"></div>

<script>
(() => {

const MAX_DIMENSION = 1000;
const worker = new Worker('worker.js');

worker.addEventListener('message', (e) => {
	console.log(`Parent: Got message of type "${e.data.type}"`);
	if (e.data.type === 'result') {
		outputImage(e.data);
	}
});

window.addEventListener('dragover', (e) => {
	e.preventDefault();
});

window.addEventListener('drop', (e) => {
	e.preventDefault();
	if (!e.dataTransfer) return;
	const dataTransfer = e.dataTransfer;
	if (!dataTransfer.files) return;
	const files = dataTransfer.files;
	if (!files[0]) return;
	const file = files[0];
	handleFile(file);
});

const fileInput = document.querySelector('#file');
fileInput.addEventListener('change', (e) => {
	e.preventDefault();
	if (!fileInput.files) return;
	const files = fileInput.files;
	if (!files[0]) return;
	const file = files[0];
	handleFile(file);
	fileInput.value = '';
});

const amountInput = document.querySelector('#amount');
const getAmount = () => Number(amountInput.value);

/**
 * @param {File} file
 * @returns {Promise<void>}
 */
const handleFile = (file) => {
	return Promise.resolve(file)
		.then(getDataURLFromFile)
		.then(getImageFromDataURL)
		.then(processImage);
};

/**
 * @param {File} file
 * @returns {Promise<string>}
 */
const getDataURLFromFile = (file) => (
	new Promise((resolve, reject) => {
		const reader = new FileReader();
		reader.addEventListener('load', () => resolve(reader.result));
		reader.addEventListener('error', reject);
		reader.readAsDataURL(file);
	})
);

/**
 * @param {string} dataURL
 * @returns {Image}
 */
const getImageFromDataURL = (dataURL) => {
	const image = new Image();
	image.src = dataURL;
	return image;
};

/**
 * @param {Image} image
 * @returns {Promise<Image>}
 */
const processImage = (image) => {
	const amount = getAmount();
	const imageWidth = image.width;
	const imageHeight = image.height;
	const resize = imageWidth > MAX_DIMENSION || imageHeight > MAX_DIMENSION;
	const scale = resize ? MAX_DIMENSION / Math.max(imageWidth, imageHeight) : 1;
	const width = scale * imageWidth;
	const height = scale * imageHeight;
	const canvas = document.createElement('canvas');
	canvas.width = width;
	canvas.height = height;
	const ctx = canvas.getContext('2d');
	if (!ctx) {
		throw new Error('Could not get context for canvas');
	}
	ctx.drawImage(image, 0, 0, width, height);
	const getIndex = (x, y) => 4 * (y * width + x);
	const imageData = ctx.getImageData(0, 0, width, height);
	worker.postMessage({
		type: 'filter',
		data: imageData.data,
		options: {
			width,
			height,
			amount,
		},
	});
};

const copyData = (source, dest) => {
	for (let i = 0; i < source.length; i++) {
		dest[i] = source[i];
	}
};

/**
 * @param {Image} image
 */
const outputImage = (data) => {
	const options = data.options;
	const width = options.width;
	const height = options.height;
	const canvas = document.createElement('canvas');
	canvas.width = width;
	canvas.height = height;
	const ctx = canvas.getContext('2d');
	const imageData = new ImageData(width, height);
	copyData(data.data, imageData.data);
	ctx.putImageData(imageData, 0, 0);
	const image = new Image();
	image.src = canvas.toDataURL();
	document.querySelector('#output').appendChild(image);
};

})();
</script>

<style>
#output img {
	display: block;
	margin: 1em 0;
}
</style>
